name: Test Pyramid

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Run unit tests
      run: cargo test --lib
    
    - name: Run doc tests
      run: cargo test --doc

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Run integration tests
      run: cargo test --test integration_tests

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Run E2E tests
      run: cargo test --test e2e_tests

  performance-comparison:
    name: Performance Comparison Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Install Python dependencies
      run: pip install requests
    
    - name: Run performance comparison tests (Python-based)
      run: cargo test --test perf_comparison_tests -- --ignored

  dotnet-performance-tests:
    name: .NET Performance Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Install Python dependencies
      run: pip install requests
    
    - name: Build Rust proxy (release mode)
      run: cargo build --release
    
    - name: Build .NET HTTP Service
      run: |
        cd examples/dotnet-perf-test/HttpService
        dotnet build -o ../bin/HttpService
    
    - name: Build .NET Pipe Service
      run: |
        cd examples/dotnet-perf-test/PipeService
        dotnet build -o ../bin/PipeService
    
    - name: Verify PipeService has no HTTP dependencies
      run: |
        cd examples/dotnet-perf-test/PipeService
        OUTPUT=$(dotnet list package)
        echo "$OUTPUT"
        if echo "$OUTPUT" | grep -q "No packages were found"; then
          echo "✓ PipeService has no package dependencies"
        else
          echo "✗ PipeService has unexpected dependencies"
          exit 1
        fi
    
    - name: Run .NET performance tests
      run: |
        cd examples/dotnet-perf-test
        timeout 600 python3 run_performance_tests.py || echo "Tests completed with issues"
      continue-on-error: true
    
    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: |
          examples/dotnet-perf-test/performance_results.json
          examples/dotnet-perf-test/PERFORMANCE_RESULTS.md
        if-no-files-found: warn

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Check formatting
      run: cargo fmt -- --check
      continue-on-error: true
    
    - name: Run clippy
      run: cargo clippy -- -D warnings
      continue-on-error: true
    
    - name: Build debug
      run: cargo build
    
    - name: Build release
      run: cargo build --release

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, performance-comparison, dotnet-performance-tests, build-check]
    if: always()
    
    steps:
    - name: Check test results
      run: |
        echo "## Test Pyramid Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Performance Comparison: ${{ needs.performance-comparison.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- .NET Performance Tests: ${{ needs.dotnet-performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Check: ${{ needs.build-check.result }}" >> $GITHUB_STEP_SUMMARY
